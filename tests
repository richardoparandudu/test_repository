Option Explicit

Public Sub AutoSelect_Tracks_ToNewWorksheet()

    Const SRC_SHEET As String = "IQ_Prep_2"
    Const OUT_SHEET As String = "Auto_Selected"
    Const MAX_SELECT As Long = 425

    Dim wsSrc As Worksheet, wsOut As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim srcData As Variant, outData() As Variant
    Dim r As Long, c As Long
    Dim selectedCount As Long

    Dim cutoffDate As Date
    cutoffDate = DateAdd("yyyy", 2, Date)

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    '------------------------------------------------------------
    ' Load source data
    '------------------------------------------------------------
    Set wsSrc = ThisWorkbook.Worksheets(SRC_SHEET)

    lastCol = wsSrc.Cells(1, wsSrc.Columns.Count).End(xlToLeft).Column
    lastRow = wsSrc.Cells(wsSrc.Rows.Count, 1).End(xlUp).Row
    If lastRow < 2 Then GoTo CleanExit

    srcData = wsSrc.Range(wsSrc.Cells(1, 1), wsSrc.Cells(lastRow, lastCol)).Value2

    '------------------------------------------------------------
    ' Create / reset output sheet
    '------------------------------------------------------------
    On Error Resume Next
    Set wsOut = ThisWorkbook.Worksheets(OUT_SHEET)
    On Error GoTo 0

    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Worksheets.Add
        wsOut.Name = OUT_SHEET
    Else
        wsOut.Cells.Clear
    End If

    '------------------------------------------------------------
    ' Build output array: Selected + all IQ_Prep_2 columns
    '------------------------------------------------------------
    ReDim outData(1 To UBound(srcData, 1), 1 To UBound(srcData, 2) + 1)

    outData(1, 1) = "Selected"
    For c = 1 To UBound(srcData, 2)
        outData(1, c + 1) = srcData(1, c)
    Next c

    For r = 2 To UBound(srcData, 1)
        outData(r, 1) = False
        For c = 1 To UBound(srcData, 2)
            outData(r, c + 1) = srcData(r, c)
        Next c
    Next r

    wsOut.Range(wsOut.Cells(1, 1), _
                wsOut.Cells(UBound(outData, 1), UBound(outData, 2))).Value2 = outData

    '------------------------------------------------------------
    ' Recompute lastRow/lastCol for output sheet
    '------------------------------------------------------------
    lastCol = wsOut.Cells(1, wsOut.Columns.Count).End(xlToLeft).Column
    lastRow = wsOut.Cells(wsOut.Rows.Count, 1).End(xlUp).Row

    '------------------------------------------------------------
    ' Locate required columns in OUTPUT
    '------------------------------------------------------------
    Dim colSelected As Long: colSelected = 1
    Dim colPremEff As Long: colPremEff = FindHeaderCol(wsOut, "Prem Eff Date")
    Dim colRenewal As Long: colRenewal = FindHeaderCol(wsOut, "Renewal Only")
    Dim colMissing As Long: colMissing = FindHeaderCol(wsOut, "Missing Data")
    Dim colTierType As Long: colTierType = FindHeaderCol(wsOut, "Tier Type")
    Dim colGroupRank As Long: colGroupRank = FindHeaderCol(wsOut, "Group Rank")
    Dim colMktShare As Long: colMktShare = FindHeaderCol(wsOut, "Market Share")
    Dim colCustNote As Long: colCustNote = FindHeaderCol(wsOut, "Customer Note", False)

    If colPremEff = 0 Or colRenewal = 0 Or colMissing = 0 Or colTierType = 0 _
       Or colGroupRank = 0 Or colMktShare = 0 Then
        MsgBox "One or more required columns are missing on the output sheet.", vbCritical
        GoTo CleanExit
    End If

    '------------------------------------------------------------
    ' Prem Eff Date fix:
    ' Normalize Prem Eff Date cells into real Excel dates where possible
    '------------------------------------------------------------
    NormalizePremEffDates_Robust wsOut, colPremEff, lastRow

    '------------------------------------------------------------
    ' UX highlighting
    '------------------------------------------------------------
    If colCustNote > 0 Then
        wsOut.Range(wsOut.Cells(2, colCustNote), wsOut.Cells(lastRow, colCustNote)).Interior.ColorIndex = xlNone
    End If
    wsOut.Range(wsOut.Cells(2, colTierType), wsOut.Cells(lastRow, colTierType)).Interior.ColorIndex = xlNone

    For r = 2 To lastRow
        If colCustNote > 0 Then
            If Len(Trim$(CStr(wsOut.Cells(r, colCustNote).Value2))) > 0 Then
                wsOut.Cells(r, colCustNote).Interior.Color = RGB(255, 255, 153)
            End If
        End If

        If LCase$(Trim$(CStr(wsOut.Cells(r, colTierType).Value2))) = "mixed" Then
            wsOut.Cells(r, colTierType).Interior.Color = RGB(255, 255, 153)
        End If
    Next r

    '------------------------------------------------------------
    ' Apply selection criteria (single pass, capped) INCLUDING Prem Eff Date rule
    '------------------------------------------------------------
    selectedCount = 0

    For r = 2 To lastRow

        If selectedCount >= MAX_SELECT Then Exit For

        If IsEligible_WithPremEff(wsOut, r, cutoffDate, _
                                 colPremEff, colRenewal, colMissing, _
                                 colTierType, colGroupRank, colMktShare) Then

            wsOut.Cells(r, colSelected).Value2 = True
            selectedCount = selectedCount + 1

        End If

    Next r

    MsgBox "Selections completed. Selected count = " & selectedCount & _
           " (max " & MAX_SELECT & ").", vbInformation

CleanExit:
    Application.EnableEvents = True
    Application.ScreenUpdating = True

End Sub

' Robust normalization:
' - Handles real Excel date serials
' - Handles CDate-able strings
' - Handles "YYYY-MM-DD" (common export format) even if CDate fails
Private Sub NormalizePremEffDates_Robust(ByVal ws As Worksheet, ByVal colPremEff As Long, ByVal lastRow As Long)

    Dim r As Long
    Dim v As Variant
    Dim s As String
    Dim y As Long, m As Long, d As Long

    For r = 2 To lastRow

        v = ws.Cells(r, colPremEff).Value2

        ' If it's already numeric date serial, keep it (Excel dates are numbers)
        If IsNumeric(v) Then
            ' Only coerce if it looks like a plausible Excel date serial
            If CDbl(v) > 1000# And CDbl(v) < 60000# Then
                ws.Cells(r, colPremEff).Value = DateSerial(1899, 12, 30) + CDbl(v)
            End If

        Else
            s = Trim$(CStr(ws.Cells(r, colPremEff).Value))

            If Len(s) = 0 Then GoTo NextRow

            ' First try normal conversion
            On Error Resume Next
            ws.Cells(r, colPremEff).Value = CDate(s)
            If Err.Number = 0 Then
                On Error GoTo 0
                GoTo NextRow
            End If
            Err.Clear
            On Error GoTo 0

            ' Try parsing YYYY-MM-DD
            ' Example: 2025-01-16
            If Len(s) >= 10 Then
                If Mid$(s, 5, 1) = "-" And Mid$(s, 8, 1) = "-" Then
                    On Error Resume Next
                    y = CLng(Left$(s, 4))
                    m = CLng(Mid$(s, 6, 2))
                    d = CLng(Mid$(s, 9, 2))
                    If Err.Number = 0 Then
                        ws.Cells(r, colPremEff).Value = DateSerial(y, m, d)
                    End If
                    On Error GoTo 0
                End If
            End If
        End If

NextRow:
    Next r

End Sub

Private Function IsEligible_WithPremEff( _
    ByVal ws As Worksheet, ByVal r As Long, ByVal cutoffDate As Date, _
    ByVal colPremEff As Long, ByVal colRenewal As Long, ByVal colMissing As Long, _
    ByVal colTierType As Long, ByVal colGroupRank As Long, ByVal colMktShare As Long) As Boolean

    IsEligible_WithPremEff = False

    ' Prem Eff Date: if over 2 years from today -> reject
    ' After normalization, valid dates should pass IsDate(.Value)
    If Not IsDate(ws.Cells(r, colPremEff).Value) Then Exit Function
    If CDate(ws.Cells(r, colPremEff).Value) > cutoffDate Then Exit Function

    ' Renewal Only = Yes -> reject
    If LCase$(Trim$(CStr(ws.Cells(r, colRenewal).Value2))) = "yes" Then Exit Function

    ' Missing Data not empty -> reject
    If Len(Trim$(CStr(ws.Cells(r, colMissing).Value2))) > 0 Then Exit Function

    ' Tier Type = Manual -> reject
    If LCase$(Trim$(CStr(ws.Cells(r, colTierType).Value2))) = "manual" Then Exit Function

    ' Group Rank > 10 -> reject
    If Not IsNumeric(ws.Cells(r, colGroupRank).Value2) Then Exit Function
    If CDbl(ws.Cells(r, colGroupRank).Value2) > 10 Then Exit Function

    ' Market Share < 0.02 -> reject
    If Not IsNumeric(ws.Cells(r, colMktShare).Value2) Then Exit Function
    If CDbl(ws.Cells(r, colMktShare).Value2) < 0.02 Then Exit Function

    IsEligible_WithPremEff = True
End Function

Private Function FindHeaderCol(ByVal ws As Worksheet, ByVal headerName As String, Optional ByVal required As Boolean = True) As Long
    Dim lastCol As Long, c As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For c = 1 To lastCol
        If LCase$(Trim$(CStr(ws.Cells(1, c).Value2))) = LCase$(headerName) Then
            FindHeaderCol = c
            Exit Function
        End If
    Next c

    FindHeaderCol = 0
End Function
