'------------------------------------------------------------
' Step 2: allocate remaining by Mesler share ranking (up to 2 passes)
'------------------------------------------------------------
If selectedTotal < MAX_SELECT And meslerShareByState.Count > 0 Then

    Dim states() As String, shares() As Double
    BuildStateShareArrays meslerShareByState, states, shares
    SortStatesByShareDesc states, shares

    Dim pass As Long, sIdx As Long
    Dim passAdded As Long

    For pass = 1 To MAX_MESLER_PASSES

        If selectedTotal >= MAX_SELECT Then Exit For

        passAdded = 0  ' track whether we made any selections this pass

        For sIdx = LBound(states) To UBound(states)

            If selectedTotal >= MAX_SELECT Then Exit For

            st = states(sIdx)
            If Not eligibleByState.Exists(st) Then GoTo NextState

            If Not selectedCountByState.Exists(st) Then selectedCountByState.Add st, 0

            Set coll = eligibleByState(st)
            rowNum = GetNextUnselectedRowForState(wsOut, colSelected, coll)

            If rowNum > 0 Then
                wsOut.Cells(rowNum, colSelected).Value2 = True
                selectedTotal = selectedTotal + 1
                selectedCountByState(st) = CLng(selectedCountByState(st)) + 1
                passAdded = passAdded + 1
            End If

NextState:
        Next sIdx

        ' If we didn't add anything in this pass, stop early
        If passAdded = 0 Then Exit For

    Next pass

End If
