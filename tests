Option Explicit

'================================================================================
' Creates a NEW worksheet output that contains:
'   - All data from IQ_Prep_2
'   - A new first column: "Selected" (with linked checkboxes)
'   - UX highlights:
'       * "Customer Note" cells highlighted if non-empty
'       * "Tier Type" cells highlighted if "Mixed"
'
' Auto-selection rules (max 425):
'   - Group number = 8  => ALWAYS selected (overrides all other criteria)
'   - Prem Eff Date > (today + 2 years) => cannot be selected
'   - Renewal Only = "Yes"              => cannot be selected
'   - Missing Data not empty            => cannot be selected
'   - Tier Type = "Manual"              => cannot be selected
'   - Group Rank > 10                   => cannot be selected
'   - Market Share < 0.02               => cannot be selected
'
' Selection order:
'   1) Select all Group 8 rows first
'   2) Then select eligible rows top-to-bottom until 425 is reached
'
' Output sheet name: Auto_Selected
'================================================================================
Public Sub AutoSelect_Tracks_ToNewWorksheet()

    Const SRC_SHEET As String = "IQ_Prep_2"
    Const OUT_SHEET As String = "Auto_Selected"
    Const MAX_SELECT As Long = 425

    Dim wsSrc As Worksheet, wsOut As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim srcData As Variant, outData() As Variant
    Dim r As Long, c As Long
    Dim selectedCount As Long
    Dim cutoffDate As Date: cutoffDate = DateAdd("yyyy", 2, Date)

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    '------------------------------------------------------------
    ' 1) Get source sheet
    '------------------------------------------------------------
    On Error Resume Next
    Set wsSrc = ThisWorkbook.Worksheets(SRC_SHEET)
    On Error GoTo 0
    If wsSrc Is Nothing Then
        MsgBox "Sheet '" & SRC_SHEET & "' not found.", vbCritical
        GoTo CleanExit
    End If

    lastCol = wsSrc.Cells(1, wsSrc.Columns.Count).End(xlToLeft).Column
    lastRow = wsSrc.Cells(wsSrc.Rows.Count, 1).End(xlUp).Row
    If lastRow < 2 Then GoTo CleanExit

    srcData = wsSrc.Range(wsSrc.Cells(1, 1), wsSrc.Cells(lastRow, lastCol)).Value2

    '------------------------------------------------------------
    ' 2) Create/clear output sheet
    '------------------------------------------------------------
    On Error Resume Next
    Set wsOut = ThisWorkbook.Worksheets(OUT_SHEET)
    On Error GoTo 0

    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Worksheets(ThisWorkbook.Worksheets.Count))
        wsOut.Name = OUT_SHEET
    Else
        wsOut.Cells.Clear
        DeleteAllCheckboxes wsOut
    End If

    '------------------------------------------------------------
    ' 3) Build output array: Selected + all IQ_Prep_2 columns
    '------------------------------------------------------------
    ReDim outData(1 To UBound(srcData, 1), 1 To UBound(srcData, 2) + 1)

    outData(1, 1) = "Selected"
    For c = 1 To UBound(srcData, 2)
        outData(1, c + 1) = srcData(1, c)
    Next c

    For r = 2 To UBound(srcData, 1)
        outData(r, 1) = False
        For c = 1 To UBound(srcData, 2)
            outData(r, c + 1) = srcData(r, c)
        Next c
    Next r

    wsOut.Range(wsOut.Cells(1, 1), wsOut.Cells(UBound(outData, 1), UBound(outData, 2))).Value2 = outData

    '------------------------------------------------------------
    ' 4) Find required columns in OUTPUT (row 1 headers)
    '     (these are shifted by +1 because of Selected col)
    '------------------------------------------------------------
    Dim colSelected As Long: colSelected = 1
    Dim colGroupNum As Long: colGroupNum = FindHeaderCol(wsOut, "Group number")
    Dim colState As Long: colState = FindHeaderCol(wsOut, "State")
    Dim colPremEff As Long: colPremEff = FindHeaderCol(wsOut, "Prem Eff Date")
    Dim colRenewal As Long: colRenewal = FindHeaderCol(wsOut, "Renewal Only")
    Dim colMissing As Long: colMissing = FindHeaderCol(wsOut, "Missing Data")
    Dim colTierType As Long: colTierType = FindHeaderCol(wsOut, "Tier Type")
    Dim colGroupRank As Long: colGroupRank = FindHeaderCol(wsOut, "Group Rank")
    Dim colMktShare As Long: colMktShare = FindHeaderCol(wsOut, "Market Share")

    ' Optional UX column
    Dim colCustNote As Long: colCustNote = FindHeaderCol(wsOut, "Customer Note", False)

    If colGroupNum = 0 Or colState = 0 Or colPremEff = 0 Or colRenewal = 0 Or colMissing = 0 _
       Or colTierType = 0 Or colGroupRank = 0 Or colMktShare = 0 Then
        MsgBox "One or more required columns are missing on the output sheet.", vbCritical
        GoTo CleanExit
    End If

    '------------------------------------------------------------
    ' 5) UX highlighting
    '------------------------------------------------------------
    ApplyUXHighlighting wsOut, lastRow, colCustNote, colTierType

    '------------------------------------------------------------
    ' 6) Select mandatory Group = 8 first
    '------------------------------------------------------------
    selectedCount = 0
    For r = 2 To lastRow
        If IsGroupEight(wsOut.Cells(r, colGroupNum).Value2) Then
            wsOut.Cells(r, colSelected).Value2 = True
            selectedCount = selectedCount + 1
        End If
    Next r

    '------------------------------------------------------------
    ' 7) Select eligible non-Group8 until cap
    '------------------------------------------------------------
    If selectedCount < MAX_SELECT Then
        For r = 2 To lastRow
            If selectedCount >= MAX_SELECT Then Exit For
            If CBoolSafe(wsOut.Cells(r, colSelected).Value2) Then GoTo NextRow

            If IsEligibleNonGroup8(wsOut, r, cutoffDate, _
                                   colPremEff, colRenewal, colMissing, colTierType, colGroupRank, colMktShare) Then
                wsOut.Cells(r, colSelected).Value2 = True
                selectedCount = selectedCount + 1
            End If
NextRow:
        Next r
    End If

    '------------------------------------------------------------
    ' 8) Add linked checkboxes in Selected column
    '------------------------------------------------------------
    AddLinkedCheckboxes wsOut, colSelected, lastRow

    '------------------------------------------------------------
    ' 9) Final message
    '------------------------------------------------------------
    If selectedCount > MAX_SELECT Then
        MsgBox "Selections completed, but mandatory Group number = 8 rows exceed the 425 cap." & vbCrLf & _
               "Selected count = " & selectedCount & "." & vbCrLf & _
               "You may need to manually deselect.", vbExclamation
    Else
        MsgBox "Selections completed. Selected count = " & selectedCount & " (max " & MAX_SELECT & ").", vbInformation
    End If

CleanExit:
    Application.EnableEvents = True
    Application.ScreenUpdating = True

End Sub

'===============================
' Helpers
'===============================

Private Function FindHeaderCol(ByVal ws As Worksheet, ByVal headerName As String, Optional ByVal required As Boolean = True) As Long
    Dim lastCol As Long, c As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For c = 1 To lastCol
        If LCase$(Trim$(CStr(ws.Cells(1, c).Value2))) = LCase$(headerName) Then
            FindHeaderCol = c
            Exit Function
        End If
    Next c

    If required Then
        FindHeaderCol = 0
    Else
        FindHeaderCol = 0
    End If
End Function

Private Sub DeleteAllCheckboxes(ByVal ws As Worksheet)
    Dim shp As Shape
    For Each shp In ws.Shapes
        If shp.Type = msoFormControl Then
            If shp.FormControlType = xlCheckBox Then shp.Delete
        End If
    Next shp
End Sub

Private Sub ApplyUXHighlighting(ByVal ws As Worksheet, ByVal lastRow As Long, ByVal colCustNote As Long, ByVal colTierType As Long)
    If colCustNote > 0 Then
        ws.Range(ws.Cells(2, colCustNote), ws.Cells(lastRow, colCustNote)).Interior.ColorIndex = xlNone
    End If
    ws.Range(ws.Cells(2, colTierType), ws.Cells(lastRow, colTierType)).Interior.ColorIndex = xlNone

    Dim r As Long
    For r = 2 To lastRow
        If colCustNote > 0 Then
            If Len(Trim$(CStr(ws.Cells(r, colCustNote).Value2))) > 0 Then
                ws.Cells(r, colCustNote).Interior.Color = RGB(255, 255, 153)
            End If
        End If

        If LCase$(Trim$(CStr(ws.Cells(r, colTierType).Value2))) = "mixed" Then
            ws.Cells(r, colTierType).Interior.Color = RGB(255, 255, 153)
        End If
    Next r
End Sub

Private Function IsGroupEight(ByVal v As Variant) As Boolean
    If IsNumeric(v) Then
        IsGroupEight = (CLng(v) = 8)
    Else
        IsGroupEight = (Trim$(CStr(v)) = "8")
    End If
End Function

Private Function IsEligibleNonGroup8( _
    ByVal ws As Worksheet, ByVal r As Long, ByVal cutoffDate As Date, _
    ByVal colPremEff As Long, ByVal colRenewal As Long, ByVal colMissing As Long, _
    ByVal colTierType As Long, ByVal colGroupRank As Long, ByVal colMktShare As Long) As Boolean

    IsEligibleNonGroup8 = False

    Dim vDate As Variant: vDate = ws.Cells(r, colPremEff).Value2
    If IsDate(vDate) Then
        If CDate(vDate) > cutoffDate Then Exit Function
    Else
        Exit Function
    End If

    If LCase$(Trim$(CStr(ws.Cells(r, colRenewal).Value2))) = "yes" Then Exit Function
    If Len(Trim$(CStr(ws.Cells(r, colMissing).Value2))) > 0 Then Exit Function
    If LCase$(Trim$(CStr(ws.Cells(r, colTierType).Value2))) = "manual" Then Exit Function

    Dim vRank As Variant: vRank = ws.Cells(r, colGroupRank).Value2
    If IsNumeric(vRank) Then
        If CDbl(vRank) > 10# Then Exit Function
    ElseIf Len(Trim$(CStr(vRank))) > 0 Then
        Exit Function
    End If

    Dim vMS As Variant: vMS = ws.Cells(r, colMktShare).Value2
    If IsNumeric(vMS) Then
        If CDbl(vMS) < 0.02 Then Exit Function
    ElseIf Len(Trim$(CStr(vMS))) > 0 Then
        Exit Function
    End If

    IsEligibleNonGroup8 = True
End Function

Private Sub AddLinkedCheckboxes(ByVal ws As Worksheet, ByVal colSelected As Long, ByVal lastRow As Long)
    Dim r As Long
    Dim cb As CheckBox
    Dim cell As Range

    For r = 2 To lastRow
        Set cell = ws.Cells(r, colSelected)

        Set cb = ws.CheckBoxes.Add(cell.Left + 2, cell.Top + 2, cell.Width - 4, cell.Height - 4)
        cb.LinkedCell = cell.Address(False, False)
        cb.Caption = ""
        cb.Value = IIf(CBoolSafe(cell.Value2), xlOn, xlOff)
    Next r

    ws.Columns(colSelected).ColumnWidth = 4
End Sub

Private Function CBoolSafe(ByVal v As Variant) As Boolean
    On Error GoTo Nope
    If IsEmpty(v) Then GoTo Nope
    If VarType(v) = vbBoolean Then
        CBoolSafe = v
    ElseIf IsNumeric(v) Then
        CBoolSafe = (CDbl(v) <> 0)
    Else
        CBoolSafe = (LCase$(Trim$(CStr(v))) = "true" Or LCase$(Trim$(CStr(v))) = "yes")
    End If
    Exit Function
Nope:
    CBoolSafe = False
End Function

